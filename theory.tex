\chapter{Theoretical background}

\section{Mapping operator}
\sasha
mapping scheme ($c_{Ii}$ coefficients) \\
picture \\
translation invariance \\
definition of the mass \\
definition of specific and involved atoms \\

In this section our description follows an excellent analysis given in \cite{Noid:2008.1}

Mapping scheme is an operator, which maps an atomistic representation of the system onto a coarse-grained one.
Atomistic system is described specifying the values of the Cartesian coordinates $\bm r^n = \{\bm r_1,...,\bm r_n\}$ and momenta 
$\bm p^n = \{\bm p_1,...,\bm p_n\}$ of the $n$ atoms in the system. Since we want to describe our system on a coarse-grained level, we need to introduce CG coordinates and momenta, which have a strictly defined meaning in terms of atomistic coordinates and momenta. The physical meaning of the CG sites $\bm R^N = \{\bm R_1,...,\bm R_N\}$ is specified by a linear mapping operator
$\bm M_R^N(\bm r^n) = \{\bm M_{R1}(\bm r^n),...,\bm M_{RN}(\bm r^n)\}$

\begin{equation}
 \bm M_{RI}(\bm r^n)=\sum_{i=1}^{n}c_{Ii}\bm r_i \, \rm for\, \it I = 1,...,N
\label{eq:mapping_scheme}
\end{equation}

Analogously, the physical meaning of the CG momenta $\bm P^N = \{\bm P_1,...,\bm P_N\}$ is

\begin{equation}
 \bm M_{PI}(\bm r^n)=M_I\sum_{i=1}^{n}c_{Ii}\bm p_i/m_i \, \rm for\, \it I = 1,...,N
\end{equation}
All together those {\it N} functions is a linear operator denoted by $\bm M_P^N(\bm p^n)$

Mapping operator should satisfy a certain condition, related to translational invariance. If an atomistic system is translated by the vector displacement $\bm r $, corresponding coarse-grained system is similarly translated by the same vector. This imposes the following condition on the mapping coefficients $ c_{Ii} $:

\begin{equation}
 \sum_{i=1}^{n}c_{Ii}=1\, \rm for\, all\, \it I
\end{equation}

It might be useful to define CG mapping in a way that certain atoms belong to several CG beads at the same time \cite{Fritz:2009}.
In order to understand this situation one needs to define two special sets of atoms for each of the {\it N} CG beads. For each site {\it I}, a set of {\it involved} atoms is defined as:

\begin{equation}
 {\tt I}_I=\{i|c_{Ii}\ne0\}
\end{equation}
An atom {\it i} in the atomistic model is involved in a CG site {\it I} if and only if the atoms provides a nonzero contribution to the sum in Eq.\ref{eq:mapping_scheme}.

A set of {\it specific} atoms is defined as:
\begin{equation}
 {\tt S}_I=\{i|c_{Ii}\ne0\, {\rm and}\, c_{Ji}=0\, {\rm for\,all}\, J\ne I\}
\end{equation}

In other words, atom {\it i} is specific to site {\it I} if and only if the atom is involved in site {\it I} and is not involved in the definition of any other site.

It can be shown (see \cite{Noid:2008.1}) that a CG model will generate an equilibrium distribution of momenta that is consistent with an underlying atomistic model if all the atoms are {\it specific} and if the mass of the CG sites is chosen according to

\begin{equation}
M_I= \left( \sum_{i \in {\tt I}_I}\frac{c_{Ii}^2}{m_i} \right)^{-1}\, \rm for\, all\, {\it I}
\end{equation}

\section{Boltzmann inversion}
Boltzmann inversion is the simplest method one can use to obtain coarse-grained potentials~\cite{Tschoep:1998}. It is mostly used for {\em bonded} potentials, such as bonds, angles, and torsions. Boltzmann inversion is structure-based and only requires positions of atoms.

The potential is calculated by inverting the probability distribution $P(q)$ 
\begin{equation}
  U(q) = - k_\text{B} T \ln  P(q) ~.
  \label{eq:inv_boltzmann}
\end{equation}
%
Note that the normalization factor $Z$ is not important since it would only enter the coarse-grained potential $U(q)$ as an irrelevant additive constant.

Histograms for the bonds $H_r(r)$, angle $H_\theta(\theta)$, and torsion angle $H_\varphi(\varphi)$ have to be rescaled to obtain the volume normalized distribution functions $P_r(r)$, angle $P_\theta(\theta)$, and torsion angle $P_\varphi(\varphi)$: 
%
\begin{align}
    P_r(r) = \frac{H_r(r)}{4\pi r^2}~,
    P_\theta(\theta) = \frac{H_\theta(\theta)}{\sin \theta}~,
    P_\varphi(\varphi) = H_\varphi (\varphi)~.
    \label{eq:boltzmann_norm}
\end{align}
With bond length $\vec{r}$, angle~$\theta$ and torsion angle~$\varphi$.%
The coarse-grained potential can then be calculated by Boltzmann inversion of the distribution functions
%
\begin{align}
    \label{eq:boltzmann_pmf}
    U({r}, \theta, \varphi) &= U_r({r}) + U_{\theta}(\theta) + U_{\varphi}(\varphi)~, \\
    U_q({q}) &= - k_\text{B} T \ln P_q( q ),\; q=r, \theta, \varphi~.
    \nonumber
\end{align}

\section{Iterative Boltzmann Inversion}
In \ibi~\cite{Reith:2003}, potentials are refined iteratively. The potential update $\Delta U$ is given by
\begin{eqnarray}
  \label{eq:iter_boltzmann}
  U^{(n+1)} &=& U^{(n)} + \lambda \Delta U^{(n)}~, \\
  \Delta U^{(n)} &=&  k_\text{B} T \ln  \frac{P^{(n)}}{P_{\rm ref}}
  =  U_\text{PMF}^\text{ref} - U_\text{PMF}^{(n)}~.
\end{eqnarray}
Here $\lambda \in ]0,1]$ is a numerical factor to stabilize the scheme.

\section{Inverse Monte Carlo}
\imc is a second iterative scheme. It additionally includes cross correlations. The potential update $\Delta U$ is calculated by solving a set of linear equations
\begin{align}
    \left<S_{\alpha}\right> - S_{\alpha}^{\text{ref}}= A_{\alpha \gamma} \Delta U_{\gamma}~,
  \label{eq:imc}
\end{align}
%
with
\begin{eqnarray}
  \label{eq:covariance}
  A_{\alpha \gamma} &=& \frac{\partial \left< S_{\alpha} \right> }{\partial U_{\gamma}}  \\
  \nonumber
  &=&
  \beta \left( \left<S_{\alpha} \right>\left<S_{\gamma} \right> - \left<S_{\alpha} S_{\gamma} \right>  \right)~.
  \nonumber
\end{eqnarray}
and $S$ the histogram of the interaction. Here $S$ and $H$ from Boltzmann Inversion both mean the same, due to notation used in the original papers we keep these separat labels.

\section{Force Matching}
\sasha

Brief description with references \\
Maybe appendix with main equations \\

Force matching (\fm) is another approach to evaluate corse-grained potentials~\cite{Ercolessi:1994,Izvekov:2005,Noid:2007}. In contrast to the structure-based approaches, its aim is not to reproduce various distribution functions, but instead try to match {\em forces} on coarse-grained beads as closely as possible.

The method works as follows. We first assume that the coarse-grained force-field (and hence the forces) depends on $M$ parameters $g_1,...,g_M $. These parameters can be prefactors of analytical functions, tabulated values of the interaction potentials, or coefficients of splines used to describe these potentials.

In order to determine these parameters, the reference forces on coarse-grained beads are  calculated by properly re-weighting the forces on the atoms
\begin{equation}
  {\vec f}_i^\text{ref} = M_{i} \sum_\alpha \frac{c_\alpha {\vec f}_\alpha}{m_\alpha}~,
  \label{eq:force_mapping}
\end{equation}
where $M_{i} = \left( \sum_\alpha c^{2}_{\alpha} / m_\alpha \right)^{-1}$ is the mass of the bead $i$, index $\alpha$ numbers all atoms belonging to this bead, ${\vec f}_\alpha$ is the force on the atom $\alpha$, $m_\alpha$ is its mass, $c_\alpha$ are mapping coefficients used to obtain the position of the coarse-grained bead, ${\vec R}_i = \sum_\alpha c_\alpha r_\alpha$. If the center of mass is used in the mapping, eq.~\ref{eq:force_mapping} simplifies to the sum of the forces.

By calculating the reference forces for $L$ snapshots we can write down $N \times L$ equations
%
\begin{equation}
  {\vec f}_{il}^\text{cg}(g_1,...,g_M)=\vec f_{il}^\text{ref},\, i=1,\dots,N, l=1,\dots,L~.
  \label{eq:fmatch1}
\end{equation}
%
Here ${\vec f}_{il}^\text{ref}$ is the force on the bead $i$, ${\vec f}_{il}^\text{cg} $ is the coarse-grained representation of this force. Index $l$ enumerates snapshots picked for coarse-graining. By running the simulations long enough one can always ensure that $M < N \times L$. In this case the set of equations~\ref{eq:fmatch1} is overdetermined and can be solved in a least-squares sense.

Though the underlying idea of \fm is very simple, implementation wise it is the most complicated method. Here we briefly outline the problems, which are then discussed in more detail in Appendix~\ref{app:fm}.

Going back to the set of equations~\ref{eq:fmatch1} one can see that ${\bm f}_{il}^\text{cg}$ is, in principle, a non-linear function of its parameters $\{g_i\}$. It is, therefore, useful to represent the coarse-grained force-field in such a way that equations~(\ref{eq:fmatch1}) become linear functions of $\{g_i\}$. This can be done using splines to describe the functional form of the forces~\cite{Izvekov:2005}.

An adequate sampling of the system requires a large number of snapshots $L$. Hence, the applicability of the method is often constrained by the amount of available memory. To remedy the situation, one can split the trajectory into blocks, find the coarse-grained potential for each block and then perform averaging over the blocks. More details on the technical implementation of force matching using cubic splines is given in Appendix~\ref{app:fm}.
